/***************************************************************************
* Copyright (c) 2016, Johan Mabille, Sylvain Corlay and Wolf Vollprecht    *
*                                                                          *
* Distributed under the terms of the BSD 3-Clause License.                 *
*                                                                          *
* The full license is in the file LICENSE, distributed with this software. *
****************************************************************************/

// This file is generated from test/files/cppy_source/test_extended_broadcast_view.cppy by preprocess.py!

#include <algorithm>

#include "gtest/gtest.h"
#include "xtensor/xarray.hpp"
#include "xtensor/xfixed.hpp"
#include "xtensor/xnoalias.hpp"
#include "xtensor/xstrided_view.hpp"
#include "xtensor/xtensor.hpp"
#include "xtensor/xview.hpp"

namespace xt
{
    using namespace xt::placeholders;

    /*py
    a = np.arange(35, dtype=np.float64).reshape(5, 7)
    */
    TEST(xtest_extended, negative_slices_twod)
    {
        // py_a
        xarray<double> py_a = {{ 0., 1., 2., 3., 4., 5., 6.},
                               { 7., 8., 9.,10.,11.,12.,13.},
                               {14.,15.,16.,17.,18.,19.,20.},
                               {21.,22.,23.,24.,25.,26.,27.},
                               {28.,29.,30.,31.,32.,33.,34.}};
        // py_av0 = a[:-2, ::-1]
        xarray<double> py_av0 = {{ 6., 5., 4., 3., 2., 1., 0.},
                                 {13.,12.,11.,10., 9., 8., 7.},
                                 {20.,19.,18.,17.,16.,15.,14.}};
        auto av0 = xt::strided_view(py_a, {_r|_|-2, _r|_|_|-1});
        EXPECT_EQ(av0, py_av0);
        // py_av1 = a[::-1, ::-1]
        xarray<double> py_av1 = {{34.,33.,32.,31.,30.,29.,28.},
                                 {27.,26.,25.,24.,23.,22.,21.},
                                 {20.,19.,18.,17.,16.,15.,14.},
                                 {13.,12.,11.,10., 9., 8., 7.},
                                 { 6., 5., 4., 3., 2., 1., 0.}};
        auto av1 = xt::strided_view(py_a, {_r|_|_|-1, _r|_|_|-1});
        EXPECT_EQ(av1, py_av1);
        // py_av2 = a[1:-3, -3:2:-1]
        xarray<double> py_av2 = {{11.,10.}};
        auto av2 = xt::strided_view(py_a, {_r|1|-3, _r|-3|2|-1});
        EXPECT_EQ(av2, py_av2);
        // py_av3 = a[-1:-4:-1, -3:1:-2]
        xarray<double> py_av3 = {{32.,30.},
                                 {25.,23.},
                                 {18.,16.}};
        auto av3 = xt::strided_view(py_a, {_r|-1|-4|-1, _r|-3|1|-2});
        EXPECT_EQ(av3, py_av3);
        auto av4 = xt::strided_view(py_a, {_r|-3|-5, _r|-3|10});
        EXPECT_EQ(av4.size(), 0);
        // py_av5 = a[-5:-2, -3:10]
        xarray<double> py_av5 = {{ 4., 5., 6.},
                                 {11.,12.,13.},
                                 {18.,19.,20.}};
        auto av5 = xt::strided_view(py_a, {_r|-5|-2, _r|-3|10});
        EXPECT_EQ(av5, py_av5);
    }

    /*py
    a0 = np.arange(35).reshape(5, 7)
    a = np.copy(a0)
    a[0:-2] += a[:3:-1]
    at = np.copy(a)
    at[::-2] += at[::2]
    */
    TEST(xtest_extended, negative_slices_math)
    {
        // py_a0
        xarray<long> py_a0 = {{ 0, 1, 2, 3, 4, 5, 6},
                              { 7, 8, 9,10,11,12,13},
                              {14,15,16,17,18,19,20},
                              {21,22,23,24,25,26,27},
                              {28,29,30,31,32,33,34}};
        strided_view(py_a0, {_r|0|-2}) += strided_view(py_a0, {{_r|_|3|-1}});
        // py_a
        xarray<long> py_a = {{28,30,32,34,36,38,40},
                             {35,37,39,41,43,45,47},
                             {42,44,46,48,50,52,54},
                             {21,22,23,24,25,26,27},
                             {28,29,30,31,32,33,34}};
        EXPECT_EQ(py_a0, py_a);
        strided_view(py_a0, {_r|_|_|-2}) += strided_view(py_a0, {_r|_|_|2});
        // py_at
        xarray<long> py_at = {{ 56, 59, 62, 65, 68, 71, 74},
                              { 35, 37, 39, 41, 43, 45, 47},
                              { 84, 88, 92, 96,100,104,108},
                              { 21, 22, 23, 24, 25, 26, 27},
                              { 56, 59, 62, 65, 68, 71, 74}};
        EXPECT_EQ(py_a0, py_at);
    }

    /*py
    a1 = np.arange(35).reshape(5, 1, 7)
    a2 = np.copy(a).reshape(1, 5, 1, 7)
    a3 = np.array([6,2,3,5,1]).reshape(1, 5, 1, 1)
    a1_a2 = a1 + a2
    b1 = np.arange(7)
    b1_a1 = a1 + b1
    b2 = np.copy(b1).reshape(1, 1, 1, 7)
    a1_b2 = a1 + b2
    b3 = np.random.random((2, 5, 4, 7))
    a2_b3 = a2 + b3
    */
    TEST(xtest_extended, broadcasting)
    {
        // py_a1
        xarray<long> py_a1 = {{{ 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{ 7, 8, 9,10,11,12,13}},
                             
                              {{14,15,16,17,18,19,20}},
                             
                              {{21,22,23,24,25,26,27}},
                             
                              {{28,29,30,31,32,33,34}}};
        // py_a2
        xarray<long> py_a2 = {{{{28,30,32,34,36,38,40}},
                             
                               {{35,37,39,41,43,45,47}},
                             
                               {{42,44,46,48,50,52,54}},
                             
                               {{21,22,23,24,25,26,27}},
                             
                               {{28,29,30,31,32,33,34}}}};
        // py_b1
        xarray<long> py_b1 = {0,1,2,3,4,5,6};
        // py_b2
        xarray<long> py_b2 = {{{{0,1,2,3,4,5,6}}}};
        // py_b3
        xarray<double> py_b3 = {{{{0.10389977,0.92549538,0.25295316,0.35367765,0.79096646,0.478138  ,
                                   0.87153726},
                                  {0.1658813 ,0.54319334,0.86174079,0.84785138,0.42712533,0.98992312,
                                   0.64503601},
                                  {0.75815869,0.79888213,0.89881426,0.84492677,0.41175632,0.52467109,
                                   0.45289757},
                                  {0.15914564,0.10931928,0.24250347,0.89849668,0.72848566,0.28405122,
                                   0.65016811}},
                               
                                 {{0.4041322 ,0.45334972,0.84086935,0.46570451,0.35468913,0.26761257,
                                   0.17546062},
                                  {0.75506211,0.6013852 ,0.14949581,0.30874459,0.95421222,0.48189048,
                                   0.86367202},
                                  {0.85331845,0.80571069,0.05017398,0.64334257,0.63428307,0.41842672,
                                   0.46990115},
                                  {0.87584743,0.6179242 ,0.55136673,0.97285295,0.19745398,0.53803746,
                                   0.15116479}},
                               
                                 {{0.79144233,0.0167009 ,0.17823272,0.45838012,0.51138451,0.66306801,
                                   0.93935734},
                                  {0.21010589,0.32710029,0.50947368,0.75911319,0.00787854,0.1673444 ,
                                   0.30874425},
                                  {0.4275583 ,0.34067295,0.69688708,0.84979557,0.42514866,0.32614681,
                                   0.09076819},
                                  {0.63595264,0.40452812,0.88876953,0.75956409,0.45786013,0.55888885,
                                   0.58957168}},
                               
                                 {{0.55586038,0.61682795,0.09125963,0.89735758,0.4299609 ,0.77965463,
                                   0.98500907},
                                  {0.31729242,0.64930176,0.26262689,0.87065085,0.5156505 ,0.23224105,
                                   0.17825054},
                                  {0.6258814 ,0.41436718,0.76599916,0.86423985,0.57181411,0.37064686,
                                   0.51614663},
                                  {0.62080982,0.5231016 ,0.60670535,0.81540069,0.41848672,0.93465608,
                                   0.03932385}},
                               
                                 {{0.17429867,0.0695448 ,0.96257554,0.727303  ,0.54575626,0.54934293,
                                   0.87743208},
                                  {0.37851174,0.40814075,0.65664134,0.11606151,0.23320768,0.913739  ,
                                   0.06297343},
                                  {0.46133845,0.3036661 ,0.07385474,0.55740066,0.95188309,0.91654756,
                                   0.52471063},
                                  {0.99673528,0.35628945,0.06931578,0.69679754,0.7881278 ,0.98418039,
                                   0.19978989}}},
                               
                               
                                {{{0.89422021,0.27852269,0.07671556,0.63426608,0.03449785,0.18322813,
                                   0.31486839},
                                  {0.66719015,0.72267651,0.30174179,0.751071  ,0.74286751,0.33460366,
                                   0.18233203},
                                  {0.84897317,0.79381899,0.47545682,0.42731118,0.85708473,0.8327681 ,
                                   0.51498819},
                                  {0.70294978,0.46908853,0.66226623,0.96984043,0.892893  ,0.63527134,
                                   0.81024055}},
                               
                                 {{0.68347947,0.70392789,0.37917037,0.70972848,0.24234385,0.1266512 ,
                                   0.56510347},
                                  {0.56984072,0.75004195,0.85603635,0.46529737,0.13870903,0.08886856,
                                   0.4116058 },
                                  {0.73513649,0.38157729,0.16578983,0.85459665,0.66038865,0.63430501,
                                   0.14492156},
                                  {0.47596429,0.05580808,0.12683269,0.23390267,0.46523902,0.3352691 ,
                                   0.38981543}},
                               
                                 {{0.0995485 ,0.93959487,0.49073282,0.35711199,0.05803357,0.71772813,
                                   0.22288299},
                                  {0.75265787,0.36876879,0.61485911,0.66835392,0.22277687,0.164611  ,
                                   0.42145012},
                                  {0.65084508,0.58573139,0.52668406,0.37371362,0.67932279,0.90620492,
                                   0.27712779},
                                  {0.39949327,0.68796572,0.31077693,0.13308161,0.27681091,0.71761855,
                                   0.23180253}},
                               
                                 {{0.34423788,0.92011469,0.46776897,0.19950396,0.1753364 ,0.80504587,
                                   0.40668114},
                                  {0.48370896,0.21947091,0.95074278,0.44601721,0.51629949,0.03258641,
                                   0.17300449},
                                  {0.50776294,0.24514003,0.28598827,0.31160882,0.94319135,0.60495862,
                                   0.79851038},
                                  {0.67235695,0.54833774,0.01617316,0.44325845,0.50508948,0.13119472,
                                   0.49642271}},
                               
                                 {{0.84319875,0.51416409,0.39360204,0.305481  ,0.68403225,0.38710084,
                                   0.29694362},
                                  {0.50824771,0.29672946,0.84284336,0.00898736,0.17323122,0.30840666,
                                   0.78634607},
                                  {0.75014912,0.97272526,0.36587011,0.49760878,0.80786767,0.15378345,
                                   0.17655368},
                                  {0.97698701,0.96457527,0.83820094,0.64852044,0.60942672,0.51267801,
                                   0.82561838}}}};
        xt::xarray<long> a1_a2 = py_a1 + py_a2;
        // py_a1_a2
        xarray<long> py_a1_a2 = {{{{28,31,34,37,40,43,46}},
                                
                                  {{42,45,48,51,54,57,60}},
                                
                                  {{56,59,62,65,68,71,74}},
                                
                                  {{42,44,46,48,50,52,54}},
                                
                                  {{56,58,60,62,64,66,68}}}};
        EXPECT_EQ(a1_a2, py_a1_a2);

        xt::xarray<long> b1_a1 = py_b1 + py_a1;
        // py_b1_a1
        xarray<long> py_b1_a1 = {{{ 0, 2, 4, 6, 8,10,12}},
                                
                                 {{ 7, 9,11,13,15,17,19}},
                                
                                 {{14,16,18,20,22,24,26}},
                                
                                 {{21,23,25,27,29,31,33}},
                                
                                 {{28,30,32,34,36,38,40}}};
        EXPECT_EQ(b1_a1, py_b1_a1);

        xt::xarray<long> a1_b2 = py_a1 + py_b2;
        // py_a1_b2
        xarray<long> py_a1_b2 = {{{{ 0, 2, 4, 6, 8,10,12}},
                                
                                  {{ 7, 9,11,13,15,17,19}},
                                
                                  {{14,16,18,20,22,24,26}},
                                
                                  {{21,23,25,27,29,31,33}},
                                
                                  {{28,30,32,34,36,38,40}}}};
        EXPECT_EQ(a1_b2, py_a1_b2);

        xt::xarray<double> a2_b3 = xt::cast<double>(py_a2) + py_b3;
        // py_a2_b3
        xarray<double> py_a2_b3 = {{{{28.10389977,30.92549538,32.25295316,34.35367765,36.79096646,
                                      38.478138  ,40.87153726},
                                     {28.1658813 ,30.54319334,32.86174079,34.84785138,36.42712533,
                                      38.98992312,40.64503601},
                                     {28.75815869,30.79888213,32.89881426,34.84492677,36.41175632,
                                      38.52467109,40.45289757},
                                     {28.15914564,30.10931928,32.24250347,34.89849668,36.72848566,
                                      38.28405122,40.65016811}},
                                  
                                    {{35.4041322 ,37.45334972,39.84086935,41.46570451,43.35468913,
                                      45.26761257,47.17546062},
                                     {35.75506211,37.6013852 ,39.14949581,41.30874459,43.95421222,
                                      45.48189048,47.86367202},
                                     {35.85331845,37.80571069,39.05017398,41.64334257,43.63428307,
                                      45.41842672,47.46990115},
                                     {35.87584743,37.6179242 ,39.55136673,41.97285295,43.19745398,
                                      45.53803746,47.15116479}},
                                  
                                    {{42.79144233,44.0167009 ,46.17823272,48.45838012,50.51138451,
                                      52.66306801,54.93935734},
                                     {42.21010589,44.32710029,46.50947368,48.75911319,50.00787854,
                                      52.1673444 ,54.30874425},
                                     {42.4275583 ,44.34067295,46.69688708,48.84979557,50.42514866,
                                      52.32614681,54.09076819},
                                     {42.63595264,44.40452812,46.88876953,48.75956409,50.45786013,
                                      52.55888885,54.58957168}},
                                  
                                    {{21.55586038,22.61682795,23.09125963,24.89735758,25.4299609 ,
                                      26.77965463,27.98500907},
                                     {21.31729242,22.64930176,23.26262689,24.87065085,25.5156505 ,
                                      26.23224105,27.17825054},
                                     {21.6258814 ,22.41436718,23.76599916,24.86423985,25.57181411,
                                      26.37064686,27.51614663},
                                     {21.62080982,22.5231016 ,23.60670535,24.81540069,25.41848672,
                                      26.93465608,27.03932385}},
                                  
                                    {{28.17429867,29.0695448 ,30.96257554,31.727303  ,32.54575626,
                                      33.54934293,34.87743208},
                                     {28.37851174,29.40814075,30.65664134,31.11606151,32.23320768,
                                      33.913739  ,34.06297343},
                                     {28.46133845,29.3036661 ,30.07385474,31.55740066,32.95188309,
                                      33.91654756,34.52471063},
                                     {28.99673528,29.35628945,30.06931578,31.69679754,32.7881278 ,
                                      33.98418039,34.19978989}}},
                                  
                                  
                                   {{{28.89422021,30.27852269,32.07671556,34.63426608,36.03449785,
                                      38.18322813,40.31486839},
                                     {28.66719015,30.72267651,32.30174179,34.751071  ,36.74286751,
                                      38.33460366,40.18233203},
                                     {28.84897317,30.79381899,32.47545682,34.42731118,36.85708473,
                                      38.8327681 ,40.51498819},
                                     {28.70294978,30.46908853,32.66226623,34.96984043,36.892893  ,
                                      38.63527134,40.81024055}},
                                  
                                    {{35.68347947,37.70392789,39.37917037,41.70972848,43.24234385,
                                      45.1266512 ,47.56510347},
                                     {35.56984072,37.75004195,39.85603635,41.46529737,43.13870903,
                                      45.08886856,47.4116058 },
                                     {35.73513649,37.38157729,39.16578983,41.85459665,43.66038865,
                                      45.63430501,47.14492156},
                                     {35.47596429,37.05580808,39.12683269,41.23390267,43.46523902,
                                      45.3352691 ,47.38981543}},
                                  
                                    {{42.0995485 ,44.93959487,46.49073282,48.35711199,50.05803357,
                                      52.71772813,54.22288299},
                                     {42.75265787,44.36876879,46.61485911,48.66835392,50.22277687,
                                      52.164611  ,54.42145012},
                                     {42.65084508,44.58573139,46.52668406,48.37371362,50.67932279,
                                      52.90620492,54.27712779},
                                     {42.39949327,44.68796572,46.31077693,48.13308161,50.27681091,
                                      52.71761855,54.23180253}},
                                  
                                    {{21.34423788,22.92011469,23.46776897,24.19950396,25.1753364 ,
                                      26.80504587,27.40668114},
                                     {21.48370896,22.21947091,23.95074278,24.44601721,25.51629949,
                                      26.03258641,27.17300449},
                                     {21.50776294,22.24514003,23.28598827,24.31160882,25.94319135,
                                      26.60495862,27.79851038},
                                     {21.67235695,22.54833774,23.01617316,24.44325845,25.50508948,
                                      26.13119472,27.49642271}},
                                  
                                    {{28.84319875,29.51416409,30.39360204,31.305481  ,32.68403225,
                                      33.38710084,34.29694362},
                                     {28.50824771,29.29672946,30.84284336,31.00898736,32.17323122,
                                      33.30840666,34.78634607},
                                     {28.75014912,29.97272526,30.36587011,31.49760878,32.80786767,
                                      33.15378345,34.17655368},
                                     {28.97698701,29.96457527,30.83820094,31.64852044,32.60942672,
                                      33.51267801,34.82561838}}}};
        EXPECT_TRUE(xt::allclose(a2_b3, py_a2_b3));
    }

    /*py
    a0 = np.arange(5 * 3 * 7).reshape(5, 3, 7)
    a1 = np.copy(a0)
    b1 = np.arange(5 * 3).reshape(5, 3)
    a1[:, :, 2] = b1
    a2 = np.copy(a1)
    ar2 = np.arange(35).reshape(5, 1, 7)
    a1[:, 0, np.newaxis, :] = ar2
    a3 = np.copy(a1)
    a1[:, 2, :] = np.arange(7)
    a4 = np.copy(a1)
    ax1 = np.copy(a0)
    ax1[1, :, :] = -1
    ax2 = np.copy(a0)
    ax2[0:2, 0:2, :] = -1
    ax3 = np.copy(a0)
    ax3[1, 0:2:2, :] = -1
    ax4 = np.copy(a0)
    ax4[:, 0:2, :] = -1
    */
    TEST(xtest_extended, broadcast_into_view)
    {
        // py_a0
        xarray<long> py_a0 = {{{  0,  1,  2,  3,  4,  5,  6},
                               {  7,  8,  9, 10, 11, 12, 13},
                               { 14, 15, 16, 17, 18, 19, 20}},
                             
                              {{ 21, 22, 23, 24, 25, 26, 27},
                               { 28, 29, 30, 31, 32, 33, 34},
                               { 35, 36, 37, 38, 39, 40, 41}},
                             
                              {{ 42, 43, 44, 45, 46, 47, 48},
                               { 49, 50, 51, 52, 53, 54, 55},
                               { 56, 57, 58, 59, 60, 61, 62}},
                             
                              {{ 63, 64, 65, 66, 67, 68, 69},
                               { 70, 71, 72, 73, 74, 75, 76},
                               { 77, 78, 79, 80, 81, 82, 83}},
                             
                              {{ 84, 85, 86, 87, 88, 89, 90},
                               { 91, 92, 93, 94, 95, 96, 97},
                               { 98, 99,100,101,102,103,104}}};
        xt::xarray<long> a = py_a0;

        // py_b1
        xarray<long> py_b1 = {{ 0, 1, 2},
                              { 3, 4, 5},
                              { 6, 7, 8},
                              { 9,10,11},
                              {12,13,14}};
        // py_a2
        xarray<long> py_a2 = {{{  0,  1,  0,  3,  4,  5,  6},
                               {  7,  8,  1, 10, 11, 12, 13},
                               { 14, 15,  2, 17, 18, 19, 20}},
                             
                              {{ 21, 22,  3, 24, 25, 26, 27},
                               { 28, 29,  4, 31, 32, 33, 34},
                               { 35, 36,  5, 38, 39, 40, 41}},
                             
                              {{ 42, 43,  6, 45, 46, 47, 48},
                               { 49, 50,  7, 52, 53, 54, 55},
                               { 56, 57,  8, 59, 60, 61, 62}},
                             
                              {{ 63, 64,  9, 66, 67, 68, 69},
                               { 70, 71, 10, 73, 74, 75, 76},
                               { 77, 78, 11, 80, 81, 82, 83}},
                             
                              {{ 84, 85, 12, 87, 88, 89, 90},
                               { 91, 92, 13, 94, 95, 96, 97},
                               { 98, 99, 14,101,102,103,104}}};
        view(a, all(), all(), 2) = py_b1;
        EXPECT_EQ(a, py_a2);

        // py_ar2
        xarray<long> py_ar2 = {{{ 0, 1, 2, 3, 4, 5, 6}},
                              
                               {{ 7, 8, 9,10,11,12,13}},
                              
                               {{14,15,16,17,18,19,20}},
                              
                               {{21,22,23,24,25,26,27}},
                              
                               {{28,29,30,31,32,33,34}}};
        xt::xarray<long> ar2 = py_ar2;
        view(a, all(), 0, newaxis(), all()) = ar2;

        // py_a3
        xarray<long> py_a3 = {{{  0,  1,  2,  3,  4,  5,  6},
                               {  7,  8,  1, 10, 11, 12, 13},
                               { 14, 15,  2, 17, 18, 19, 20}},
                             
                              {{  7,  8,  9, 10, 11, 12, 13},
                               { 28, 29,  4, 31, 32, 33, 34},
                               { 35, 36,  5, 38, 39, 40, 41}},
                             
                              {{ 14, 15, 16, 17, 18, 19, 20},
                               { 49, 50,  7, 52, 53, 54, 55},
                               { 56, 57,  8, 59, 60, 61, 62}},
                             
                              {{ 21, 22, 23, 24, 25, 26, 27},
                               { 70, 71, 10, 73, 74, 75, 76},
                               { 77, 78, 11, 80, 81, 82, 83}},
                             
                              {{ 28, 29, 30, 31, 32, 33, 34},
                               { 91, 92, 13, 94, 95, 96, 97},
                               { 98, 99, 14,101,102,103,104}}};
        EXPECT_EQ(a, py_a3);

        view(a, all(), 2, all()) = xt::arange(7);
        // py_a4
        xarray<long> py_a4 = {{{ 0, 1, 2, 3, 4, 5, 6},
                               { 7, 8, 1,10,11,12,13},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{ 7, 8, 9,10,11,12,13},
                               {28,29, 4,31,32,33,34},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{14,15,16,17,18,19,20},
                               {49,50, 7,52,53,54,55},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{21,22,23,24,25,26,27},
                               {70,71,10,73,74,75,76},
                               { 0, 1, 2, 3, 4, 5, 6}},
                             
                              {{28,29,30,31,32,33,34},
                               {91,92,13,94,95,96,97},
                               { 0, 1, 2, 3, 4, 5, 6}}};
        EXPECT_EQ(a, py_a4);

        a = py_a0;
        view(a, 1, all(), all()) = -1;

        // py_ax1
        xarray<long> py_ax1 = {{{  0,  1,  2,  3,  4,  5,  6},
                                {  7,  8,  9, 10, 11, 12, 13},
                                { 14, 15, 16, 17, 18, 19, 20}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1}},
                              
                               {{ 42, 43, 44, 45, 46, 47, 48},
                                { 49, 50, 51, 52, 53, 54, 55},
                                { 56, 57, 58, 59, 60, 61, 62}},
                              
                               {{ 63, 64, 65, 66, 67, 68, 69},
                                { 70, 71, 72, 73, 74, 75, 76},
                                { 77, 78, 79, 80, 81, 82, 83}},
                              
                               {{ 84, 85, 86, 87, 88, 89, 90},
                                { 91, 92, 93, 94, 95, 96, 97},
                                { 98, 99,100,101,102,103,104}}};
        EXPECT_EQ(a, py_ax1);

        a = py_a0;
        view(a, range(0, 2), range(0, 2), all()) = -1;

        // py_ax2
        xarray<long> py_ax2 = {{{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 14, 15, 16, 17, 18, 19, 20}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 35, 36, 37, 38, 39, 40, 41}},
                              
                               {{ 42, 43, 44, 45, 46, 47, 48},
                                { 49, 50, 51, 52, 53, 54, 55},
                                { 56, 57, 58, 59, 60, 61, 62}},
                              
                               {{ 63, 64, 65, 66, 67, 68, 69},
                                { 70, 71, 72, 73, 74, 75, 76},
                                { 77, 78, 79, 80, 81, 82, 83}},
                              
                               {{ 84, 85, 86, 87, 88, 89, 90},
                                { 91, 92, 93, 94, 95, 96, 97},
                                { 98, 99,100,101,102,103,104}}};
        EXPECT_EQ(a, py_ax2);

        a = py_a0;
        view(a, all(), range(0, 2), all()) = -1;

        // py_ax4
        xarray<long> py_ax4 = {{{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 14, 15, 16, 17, 18, 19, 20}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 35, 36, 37, 38, 39, 40, 41}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 56, 57, 58, 59, 60, 61, 62}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 77, 78, 79, 80, 81, 82, 83}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { -1, -1, -1, -1, -1, -1, -1},
                                { 98, 99,100,101,102,103,104}}};
        EXPECT_EQ(a, py_ax4);

        a = py_a0;
        view(a, 1, range(0, 2, 2), all()) = -1;
        // py_ax3
        xarray<long> py_ax3 = {{{  0,  1,  2,  3,  4,  5,  6},
                                {  7,  8,  9, 10, 11, 12, 13},
                                { 14, 15, 16, 17, 18, 19, 20}},
                              
                               {{ -1, -1, -1, -1, -1, -1, -1},
                                { 28, 29, 30, 31, 32, 33, 34},
                                { 35, 36, 37, 38, 39, 40, 41}},
                              
                               {{ 42, 43, 44, 45, 46, 47, 48},
                                { 49, 50, 51, 52, 53, 54, 55},
                                { 56, 57, 58, 59, 60, 61, 62}},
                              
                               {{ 63, 64, 65, 66, 67, 68, 69},
                                { 70, 71, 72, 73, 74, 75, 76},
                                { 77, 78, 79, 80, 81, 82, 83}},
                              
                               {{ 84, 85, 86, 87, 88, 89, 90},
                                { 91, 92, 93, 94, 95, 96, 97},
                                { 98, 99,100,101,102,103,104}}};
        EXPECT_EQ(a, py_ax3);
    }

}
